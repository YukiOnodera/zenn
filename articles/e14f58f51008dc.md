---
title: e14f58f51008dc
created: 2023-12-13 19:18:29
updated: 2023-12-14 10:14:53
tags: 
aliases: 
emoji: 🤖
published: false
topics: 
type: tech
---
# はじめに
Terragrunt でPlanしたらEKS周りでエラーが出てよくわからなかったので対処法まとめます。

# 問題
下記の２件のエラーが発生しました。
EKS のエンドポイントを叩いているべきなのに、localhost になっている、、？
```shell
╷
│ Error: Get "http://localhost/api/v1/namespaces/aws-observability": dial tcp [::1]:80: connect: connection refused
│
│   with module.eks_blueprints_addons.kubernetes_namespace_v1.aws_observability[0],
│   on .terraform/modules/eks_blueprints_addons/main.tf line 2545, in resource "kubernetes_namespace_v1" "aws_observability":
│ 2545: resource "kubernetes_namespace_v1" "aws_observability" {
│
╵
```
```shell
│ Error: Get "http://localhost/api/v1/namespaces/aws-observability/configmaps/aws-logging": dial tcp [::1]:80: connect: connection refused
│
│   with module.eks_blueprints_addons.kubernetes_config_map_v1.aws_logging[0],
│   on .terraform/modules/eks_blueprints_addons/main.tf line 2558, in resource "kubernetes_config_map_v1" "aws_logging":
│ 2558: resource "kubernetes_config_map_v1" "aws_logging" {
│
╵
```

対象のリソースをstate から削除したら、とりあえずPlanは通るようになります。
が、Apply で結局似たようなエラーが発生します。
# 解決方法

provider の設定を見直すといいと思います。(最初からこっちで良かった)

下記は一例です。
```hcl
provider "kubernetes" {
host = module.eks.cluster_endpoint
cluster_ca_certificate = base64decode(module.eks.cluster_certificate_authority_data)
exec {
api_version = "client.authentication.k8s.io/v1beta1"
args = ["eks", "get-token", "--cluster-name", module.eks.cluster_name]
command = "aws"
}
# config_path = "~/.kube/config"
# config_context = module.eks.cluster_arn
}
```
# おわりに
エラーで検索したら英語のDiscussionばっかでちょっと大変だった。
ネットワーク接続エラーが出た時に、なぜかlocalhost に接続していることに違和感を持って、そこからProvider の設定を疑っていれば時間浪費せずにすぐに対処できたかも。

# 参考

```cardlink
url: https://github.com/cloudposse/terraform-aws-eks-cluster/issues/143
title: "Error: Get \"http://localhost/api/v1/namespaces/kube-system/configmaps/aws-auth\" · Issue #143 · cloudposse/terraform-aws-eks-cluster"
description: "Found a bug? Maybe our Slack Community can help. Describe the Bug I noticed that if the eks cluster is switching subnets, particularly public + private, to only private, the eks cluster will return..."
host: github.com
favicon: https://github.githubassets.com/favicons/favicon.svg
image: https://opengraph.githubassets.com/779eaa8d5425907c21cc4ce6223305550bcc66bc81bf87fdd096a566a5efe706/cloudposse/terraform-aws-eks-cluster/issues/143
```
[Error: Get "http://localhost/api/v1/namespaces/kube-system/configmaps/aws-auth" · Issue #143 · cloudposse/terraform-aws-eks-cluster · GitHub](https://github.com/cloudposse/terraform-aws-eks-cluster/issues/143)


```cardlink
url: https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs
title: "Terraform Registry"
host: registry.terraform.io
favicon: https://registry.terraform.io/images/favicons/favicon-32x32.png
```
[Terraform Registry](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs)

```cardlink
url: https://github.com/hashicorp/terraform-provider-helm/issues/893
title: "2.6.0 provider version causing `Error: Kubernetes cluster unreachable: exec plugin: invalid apiVersion` · Issue #893 · hashicorp/terraform-provider-helm"
description: "⚠️ NOTE FROM MAINTAINERS ⚠️ v1alpha1 of the client authentication API was removed in the Kubernetes client in version 1.24. The latest release of this provider was updated to use 1.24 of the Kubern..."
host: github.com
favicon: https://github.githubassets.com/favicons/favicon.svg
image: https://opengraph.githubassets.com/7c9e50273776686aa8f6ccaf934975956867904ef8c44c5c9f26a281d6b1d8d6/hashicorp/terraform-provider-helm/issues/893
```
[2.6.0 provider version causing \`Error: Kubernetes cluster unreachable: exec plugin: invalid apiVersion\` · Issue #893 · hashicorp/terraform-provider-helm · GitHub](https://github.com/hashicorp/terraform-provider-helm/issues/893)